<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <title>Puissance 4 !!</title>
    <link rel="icon" href="images/Puissance4.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&family=Kalam:wght@300;400;700&family=Dancing+Script:wght@400;500;600;700&family=Poppins:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/themes-settings.css">
    <link rel="stylesheet" href="css/modals-unified.css">
    <link rel="stylesheet" href="css/themes-settings.css">
    <link rel="stylesheet" href="css/modals-unified.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--main-font);
            background: var(--theme-gradient);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Style du bouton de retour */
        .back-button {
            position: fixed;
            top: calc(40px + env(safe-area-inset-top, 0px));
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            opacity: 1;
            visibility: visible;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            transform: scale(1.1);
        }

        .back-button i {
            font-size: 1.2rem;
        }

        /* Indicateur de connexion à la base de données principal */
        .database-connection-indicator-main {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            opacity: 0.7;
        }

        .database-connection-indicator-main.connected {
            background: rgba(76, 175, 80, 0.15);
            border-color: rgba(76, 175, 80, 0.3);
            color: rgba(76, 175, 80, 0.9);
        }

        .database-connection-indicator-main.disconnected {
            background: rgba(244, 67, 54, 0.15);
            border-color: rgba(244, 67, 54, 0.3);
            color: rgba(244, 67, 54, 0.9);
        }

        .database-connection-indicator-main.checking {
            background: rgba(255, 193, 7, 0.15);
            border-color: rgba(255, 193, 7, 0.3);
            color: rgba(255, 193, 7, 0.9);
        }

        .database-connection-indicator-main #connectionStatusIcon {
            font-size: 0.6rem;
            animation: none;
        }

        .database-connection-indicator-main.checking #connectionStatusIcon {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Media queries pour les appareils mobiles */
        @media (max-width: 767px) {
            .back-button {
                top: calc(15px + env(safe-area-inset-top, 0px));
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }

            .theme-button {
                top: calc(15px + env(safe-area-inset-top, 0px));
                left: 15px;
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }

            .settings-button {
                top: calc(15px + env(safe-area-inset-top, 0px));
                left: 70px;
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }

            .database-connection-indicator-main {
                bottom: calc(15px + env(safe-area-inset-bottom, 0px));
                right: 15px;
                padding: 6px 10px;
                font-size: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
        }

        /* Styles pour le jeu Puissance 4 */
        .game-header {
            text-align: center;
            margin: 120px 0 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .game-header h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .players-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }

        .player-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .player-card.active {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-bottom: 8px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            object-fit: cover;
        }

        .player-card.active .player-avatar {
            border-color: rgba(255, 255, 255, 0.8);
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .player-name {
            font-weight: 600;
            color: white;
            font-size: 1.1rem;
            text-align: center;
        }

        .vs-indicator {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vs-image {
            max-width: 100px;
            max-height: 80px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .game-status {
            font-size: 1.2rem;
            color: white;
            font-weight: 500;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .game-status:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .game-board-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 30px 0;
            position: relative;
        }

        /* Indicateurs de numéros de colonnes */
        .column-indicators {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            padding: 0 20px;
        }

        .column-indicator {
            width: 60px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .column-indicator.hover-active {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.6);
            transform: scale(1.1);
            opacity: 1;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 8px;
            padding: 20px;
            background: rgba(0, 50, 150, 0.3);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .game-cell {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
        }

        .game-cell.last-move {
            box-shadow: 0 0 0 2px white;
        }

        .game-cell.red {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            border-color: #ff3838;
        }

        .game-cell.yellow {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            border-color: #ffb300;
        }

        .game-cell.winning {
            animation: winningPulse 1s ease-in-out infinite;
        }

        @keyframes winningPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .game-cell.dropping {
            animation: dropAnimation 0.5s ease-out;
        }

        @keyframes dropAnimation {
            0% {
                transform: translateY(-300px);
                opacity: 0.7;
            }
            70% {
                transform: translateY(10px);
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Style pour les contours pointillés secrets */
        .game-cell.secret-border {
            border: 3px dashed rgba(255, 20, 147, 0.8) !important;
            box-shadow: 0 0 15px rgba(255, 20, 147, 0.6), inset 0 0 8px rgba(255, 192, 203, 0.3) !important;
            background: rgba(255, 20, 147, 0.1) !important;
        }

        /* Style pour le gif coeur */
        .heart-gif {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            max-width: 200px;
            max-height: 200px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(255, 192, 203, 0.4);
            animation: heartAppear 3s ease-in-out forwards;
        }

        @keyframes heartAppear {
            0% { 
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            10% { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            90% { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% { 
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }

        .game-button {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            color: white;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .game-button:hover {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .game-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .game-button.muted {
            background: rgba(255, 87, 87, 0.2);
            border-color: rgba(255, 87, 87, 0.4);
        }

        .game-button.muted:hover {
            background: rgba(255, 87, 87, 0.3);
            border-color: rgba(255, 87, 87, 0.5);
        }

        /* Contrôles de volume dans les paramètres */
        .volume-settings-section {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
        }

        .volume-settings-section h4 {
            color: white;
            font-size: 1.1rem;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        .volume-control-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .volume-control-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .volume-label {
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            min-width: 80px;
        }

        .volume-slider-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-slider {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .volume-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .volume-slider:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .volume-value {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
            min-width: 35px;
            text-align: center;
            font-weight: 500;
        }

        .volume-value.value-updated {
            color: rgba(255, 255, 255, 1);
            animation: valueUpdate 0.3s ease;
        }

        @keyframes valueUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .volume-mute-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 70px;
            justify-content: center;
        }

        .volume-mute-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .volume-mute-btn.muted {
            background: rgba(255, 87, 87, 0.2);
            border-color: rgba(255, 87, 87, 0.4);
        }

        .volume-mute-btn.muted:hover {
            background: rgba(255, 87, 87, 0.3);
            border-color: rgba(255, 87, 87, 0.5);
        }

        /* Responsive pour les contrôles de volume sur mobile */
        @media (max-width: 768px) {
            .volume-settings-section {
                margin-top: 15px;
                margin-bottom: 15px;
                padding: 15px;
            }

            .volume-settings-section h4 {
                font-size: 1rem;
                margin-bottom: 12px;
            }

            .volume-control-group {
                gap: 15px;
            }

            .volume-control-item {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .volume-label {
                min-width: auto;
                text-align: left;
                font-size: 0.9rem;
                margin-bottom: 5px;
                order: 1;
            }

            .volume-slider-container {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 12px;
                order: 2;
                width: 100%;
            }

            .volume-slider {
                height: 8px;
                flex: 1;
                max-width: none;
                min-width: 0;
                order: 1;
            }

            .volume-slider::-webkit-slider-thumb {
                width: 20px;
                height: 20px;
            }

            .volume-slider::-moz-range-thumb {
                width: 20px;
                height: 20px;
            }

            .volume-value {
                font-size: 0.75rem;
                min-width: 35px;
                flex-shrink: 0;
                order: 2;
            }

            .volume-mute-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
                min-width: 70px;
                flex-shrink: 0;
                order: 3;
            }
        }

        @media (max-width: 480px) {
            .volume-settings-section {
                padding: 12px;
            }

            .volume-control-group {
                gap: 12px;
            }

            .volume-control-item {
                gap: 8px;
                display: flex !important;
                flex-direction: column !important;
            }

            .volume-label {
                order: 1;
                margin-bottom: 5px;
            }

            .volume-slider-container {
                gap: 10px;
                order: 2;
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                width: 100%;
            }

            .volume-slider {
                flex: 1;
                min-width: 0;
                order: 1;
            }

            .volume-value {
                min-width: 32px;
                font-size: 0.7rem;
                order: 2;
                flex-shrink: 0;
            }

            .volume-mute-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
                min-width: 60px;
                order: 3;
                flex-shrink: 0;
            }

            /* Styles responsive pour les avatars des joueurs */
            .players-info {
                flex-direction: row;
                gap: 8px;
                align-items: center;
                justify-content: center;
            }

            .player-card:first-child {
                order: 1;
            }

            .vs-indicator {
                order: 2;
                font-size: 1rem;
                margin: 0 5px;
            }

            .player-card:last-child {
                order: 3;
            }

            .vs-image {
                max-width: 50px;
                max-height: 35px;
            }

            .player-card {
                padding: 10px 15px;
                min-width: 120px;
                flex: 1;
                max-width: 140px;
            }

            .player-avatar {
                width: 45px;
                height: 45px;
                margin-bottom: 4px;
            }

            .player-name {
                font-size: 0.85rem;
            }
        }

        .game-history {
            margin-top: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            text-align: center;
        }

        .game-history h3 {
            color: white;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .score-board {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }

        .score-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            min-width: 120px;
        }

        .score-label {
            color: white;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .score-value {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Modal de victoire/défaite */
        .victory-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            /* Amélioration pour iOS */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .victory-modal.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .victory-modal.closing {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.55, 0.055, 0.675, 0.19);
        }

        .victory-modal-content {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 35px 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            transform: scale(0.8) translateY(80px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            text-align: center;
        }

        .victory-modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.6), 
                transparent
            );
            z-index: 1;
        }

        .victory-modal-content::after {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            bottom: 1px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 23px;
            pointer-events: none;
            z-index: 0;
        }

        .victory-modal.show .victory-modal-content {
            transform: scale(1) translateY(0);
            animation: modalEnter 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .victory-modal.closing .victory-modal-content {
            transform: scale(0.7) translateY(-40px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.55, 0.055, 0.675, 0.19);
        }

        .victory-modal-header {
            margin-bottom: 25px;
            position: relative;
            z-index: 2;
        }

        .victory-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: victoryBounce 2s ease-in-out infinite;
        }

        .victory-title {
            color: rgba(255, 255, 255, 0.95);
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .victory-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
            font-weight: 300;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .victory-stats {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            position: relative;
            z-index: 2;
        }

        .victory-stat {
            text-align: center;
        }

        .victory-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.95);
            display: block;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .victory-stat-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 5px;
            font-weight: 500;
        }

        .victory-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            position: relative;
            z-index: 2;
        }

        .victory-button {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .victory-button:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .victory-button.primary {
            background: rgba(76, 175, 80, 0.3);
            border-color: rgba(76, 175, 80, 0.5);
        }

        .victory-button.primary:hover {
            background: rgba(76, 175, 80, 0.5);
            border-color: rgba(76, 175, 80, 0.7);
        }

        @keyframes victoryBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.1); }
        }

        /* Styles spécifiques pour victoire Benjamin */
        .victory-modal.benjamin .victory-icon {
            color: #ff4757;
        }

        .victory-modal.benjamin .victory-title {
            color: #ff4757;
        }

        /* Styles spécifiques pour victoire Sanaa */
        .victory-modal.sanaa .victory-icon {
            color: #ffd700;
        }

        .victory-modal.sanaa .victory-title {
            color: #ffd700;
        }

        /* Style pour égalité */
        .victory-modal.draw .victory-icon {
            color: #00bcd4;
        }

        .victory-modal.draw .victory-title {
            color: #00bcd4;
        }

        /* ===== Modal de confirmation ===== */
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            /* Amélioration pour iOS */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .confirmation-modal.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .confirmation-modal.closing {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.55, 0.055, 0.675, 0.19);
        }

        .confirmation-modal-content {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 35px 30px;
            max-width: 450px;
            width: 90%;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            transform: scale(0.8) translateY(80px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            text-align: center;
        }

        .confirmation-modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.6), 
                transparent
            );
            z-index: 1;
        }

        .confirmation-modal-content::after {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            bottom: 1px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 23px;
            pointer-events: none;
            z-index: 0;
        }

        .confirmation-modal.show .confirmation-modal-content {
            transform: scale(1) translateY(0);
            animation: modalEnter 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .confirmation-modal.closing .confirmation-modal-content {
            transform: scale(0.7) translateY(-40px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.55, 0.055, 0.675, 0.19);
        }

        .confirmation-modal-header {
            margin-bottom: 30px;
            position: relative;
            z-index: 2;
        }

        .confirmation-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
        }

        .confirmation-title {
            color: rgba(255, 255, 255, 0.95);
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .confirmation-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            max-width: 350px;
            margin: 0 auto;
        }

        .confirmation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            position: relative;
            z-index: 2;
        }

        .confirmation-button {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .confirmation-button:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .confirmation-button.danger {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .confirmation-button.danger:hover {
            background: rgba(239, 68, 68, 0.5);
            border-color: rgba(239, 68, 68, 0.7);
        }

        .database-connection-indicator {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .database-connection-indicator.connected {
            background: rgba(76, 175, 80, 0.15);
            border-color: rgba(76, 175, 80, 0.3);
            color: rgba(76, 175, 80, 0.9);
        }

        .database-connection-indicator.disconnected {
            background: rgba(244, 67, 54, 0.15);
            border-color: rgba(244, 67, 54, 0.3);
            color: rgba(244, 67, 54, 0.9);
        }

        .database-connection-indicator.checking {
            background: rgba(255, 193, 7, 0.15);
            border-color: rgba(255, 193, 7, 0.3);
            color: rgba(255, 193, 7, 0.9);
        }

        #connectionStatusIcon {
            font-size: 0.7rem;
            animation: none;
        }

        .database-connection-indicator.checking #connectionStatusIcon {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Responsive pour mobile */
        @media (max-width: 768px) {
            .victory-modal-content {
                padding: 25px 20px;
                margin: 20px;
                max-height: 60vh;
                width: calc(100% - 60px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .victory-modal-content::-webkit-scrollbar {
                width: 6px;
            }

            .victory-modal-content::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.4);
            }

            .victory-icon {
                font-size: 3rem;
            }

            .victory-title {
                font-size: 2rem;
            }

            .victory-subtitle {
                font-size: 0.9rem;
            }

            .victory-stats {
                flex-direction: column;
                gap: 15px;
            }

            .victory-buttons {
                flex-direction: column;
                align-items: center;
            }

            .victory-button {
                width: 100%;
                max-width: 250px;
                justify-content: center;
            }

            /* Modal de confirmation responsive */
            .confirmation-modal-content {
                padding: 25px 20px;
                margin: 20px;
                width: calc(100% - 60px);
            }

            .confirmation-icon {
                font-size: 3rem;
            }

            .confirmation-title {
                font-size: 1.5rem;
            }

            .confirmation-subtitle {
                font-size: 0.9rem;
            }

            .confirmation-buttons {
                flex-direction: column;
                align-items: center;
            }

            .confirmation-button {
                width: 100%;
                max-width: 250px;
                justify-content: center;
            }

            @keyframes modalEnter {
                0% {
                    transform: scale(0.9) translateY(50px);
                    opacity: 0;
                }
                100% {
                    transform: scale(1) translateY(0);
                    opacity: 1;
                }
            }

            .game-header {
                margin: 80px 0 20px;
                padding: 15px;
            }

            .game-header h1 {
                font-size: 2rem;
            }

            .players-info {
                gap: 15px;
                flex-direction: row;
                justify-content: center;
            }

            .vs-indicator {
                order: 1;
                font-size: 1.1rem;
            }

            .vs-image {
                max-width: 70px;
                max-height: 50px;
            }

            .player-card {
                padding: 12px 18px;
                min-width: 130px;
                flex: 1;
                max-width: 150px;
            }

            .player-avatar {
                width: 42px;
                height: 42px;
                margin-bottom: 5px;
            }

            .player-name {
                font-size: 0.9rem;
            }

            .column-indicator {
                width: 45px;
                height: 25px;
                font-size: 0.8rem;
            }

            .game-cell {
                width: 45px;
                height: 45px;
            }

            .game-board {
                gap: 6px;
                padding: 15px;
            }

            .column-indicators {
                gap: 6px;
                padding: 0 15px;
            }

            .game-controls {
                flex-direction: row;
                justify-content: center;
                gap: 15px;
            }

            .game-button {
                width: auto;
                min-width: 50px;
                padding: 12px;
                justify-content: center;
                font-size: 1.1rem;
            }

            .game-button .button-text {
                display: none;
            }

            .score-board {
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                flex-wrap: wrap;
                gap: 10px;
            }

            .score-item {
                min-width: 90px;
                padding: 10px;
                flex: 1;
                max-width: 120px;
            }

            /* Responsive pour le modal des paramètres sur mobile */
            .settings-modal-content {
                padding: 20px 15px;
                margin: 10px;
                width: calc(100% - 20px);
                max-height: 85vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .fonts-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .font-option {
                padding: 8px;
            }

            .font-preview {
                font-size: 1.2rem;
            }

            .font-name {
                font-size: 0.7rem;
            }

            .user-status-container {
                margin: 15px 0;
            }

            .connected-user-indicator {
                font-size: 0.85rem;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Bouton de retour -->
    <a href="index.html" class="back-button" id="backButton" title="Retour à l'accueil">
        <i class="fas fa-arrow-left"></i>
    </a>

    <!-- Bouton de thème -->
    <button class="theme-button" id="themeButton" onclick="openThemeModal()" title="Changer le thème">
        <i class="fas fa-palette"></i>
    </button>

    <!-- Bouton de paramètres -->
    <button class="settings-button" id="settingsButton" onclick="openSettingsModal()" title="Paramètres">
        <i class="fas fa-cog"></i>
    </button>

    <!-- Indicateur de connexion à la base de données -->
    <div id="databaseConnectionIndicator" class="database-connection-indicator-main">
        <i class="fas fa-circle" id="connectionStatusIcon"></i>
        <span id="connectionStatusText">Vérification...</span>
    </div>

    <div class="container">
        <!-- En-tête du jeu -->
        <div class="game-header">
            <h1>🔴 Puissance 4 🟡</h1>
            <div class="players-info">
                <div class="player-card" id="benjaminCard">
                    <img src="images/bAvatar.png" alt="Avatar Benjamin" class="player-avatar" onerror="this.style.display='none'">
                    <div class="player-name">Benjamin 🔴</div>
                </div>
                <div class="vs-indicator">
                    <img src="images/VS.png" alt="VS" class="vs-image" onerror="this.textContent='VS'">
                </div>
                <div class="player-card" id="sanaaCard">
                    <img src="images/sAvatar.png" alt="Avatar Sanaa" class="player-avatar" onerror="this.style.display='none'">
                    <div class="player-name">Sanaa 🟡</div>
                </div>
            </div>
            <div class="game-status" id="gameStatus">
                En attente des joueurs...
            </div>
        </div>

        <!-- Plateau de jeu -->
        <div class="game-board-container">
            <!-- Indicateurs de colonnes -->
            <div class="column-indicators">
                <div class="column-indicator" data-col="0">1</div>
                <div class="column-indicator" data-col="1">2</div>
                <div class="column-indicator" data-col="2">3</div>
                <div class="column-indicator" data-col="3">4</div>
                <div class="column-indicator" data-col="4">5</div>
                <div class="column-indicator" data-col="5">6</div>
                <div class="column-indicator" data-col="6">7</div>
            </div>
            <div class="game-board" id="gameBoard">
                <!-- Les cellules seront générées par JavaScript -->
            </div>
        </div>

        <!-- Contrôles du jeu -->
        <div class="game-controls">
            <button class="game-button" id="newGameBtn" onclick="startNewGame()">
                <i class="fas fa-play"></i><span class="button-text"> Nouvelle Partie</span>
            </button>
            <button class="game-button" id="resetBtn" onclick="resetGame()">
                <i class="fas fa-redo"></i><span class="button-text"> Recommencer</span>
            </button>
            <button class="game-button" id="musicBtn" onclick="toggleMusic()" title="Couper/Remettre la musique">
                <i class="fas fa-volume-up" id="musicIcon"></i><span class="button-text"> Musique</span>
            </button>
        </div>

        <!-- Historique des parties -->
        <div class="game-history">
            <h3>🏆 Historique des victoires</h3>
            <div class="score-board">
                <div class="score-item">
                    <span class="score-label">Benji 🔴</span>
                    <span class="score-value" id="benjaminScore">0</span>
                </div>
                <div class="score-item">
                    <span class="score-label">Sanaa 🟡</span>
                    <span class="score-value" id="sanaaScore">0</span>
                </div>
                <div class="score-item">
                    <span class="score-label">Égalités</span>
                    <span class="score-value" id="drawScore">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de victoire/défaite -->
    <div class="victory-modal" id="victoryModal">
        <div class="victory-modal-content">
            <div class="victory-modal-header">
                <div class="victory-icon" id="victoryIcon">🏆</div>
                <div class="victory-title" id="victoryTitle">Victoire !</div>
                <div class="victory-subtitle" id="victorySubtitle">Félicitations pour cette belle partie !</div>
            </div>
            
            <div class="victory-stats">
                <div class="victory-stat">
                    <span class="victory-stat-value" id="victoryBenjaminScore">0</span>
                    <div class="victory-stat-label">Benjamin 🔴</div>
                </div>
                <div class="victory-stat">
                    <span class="victory-stat-value" id="victorySanaaScore">0</span>
                    <div class="victory-stat-label">Sanaa 🟡</div>
                </div>
                <div class="victory-stat">
                    <span class="victory-stat-value" id="victoryDrawScore">0</span>
                    <div class="victory-stat-label">Égalités</div>
                </div>
            </div>

            <div class="victory-buttons">
                <button class="victory-button primary" onclick="startNewGameFromModal()">
                    <i class="fas fa-play"></i> Nouvelle Partie
                </button>
                <button class="victory-button" onclick="closeVictoryModal()">
                    <i class="fas fa-times"></i> Fermer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal pour les thèmes -->
    <div class="theme-modal" id="themeModal">
        <div class="theme-modal-content">
            <div class="theme-modal-header">
                <h3>Choisir un thème</h3>
                <p>Si tu veux changer les couleurs demande moi 😽</p>
            </div>
            <div class="themes-grid">
                <div class="theme-option" onclick="changeTheme('default')">
                    <div class="theme-circle gradient active" id="theme-circle-default" style="--theme-color-1: #667eea; --theme-color-2: #764ba2;"></div>
                    <span class="theme-name">Violet</span>
                </div>
                <div class="theme-option" onclick="changeTheme('yellow')">
                    <div class="theme-circle gradient" id="theme-circle-yellow" style="--theme-color-1: #ffd54f; --theme-color-2: #ffb300;"></div>
                    <span class="theme-name">Jaune</span>
                </div>
                <div class="theme-option" onclick="changeTheme('green')">
                    <div class="theme-circle gradient" id="theme-circle-green" style="--theme-color-1: #81c784; --theme-color-2: #4caf50;"></div>
                    <span class="theme-name">Vert</span>
                </div>
                <div class="theme-option" onclick="changeTheme('pink')">
                    <div class="theme-circle gradient" id="theme-circle-pink" style="--theme-color-1: #f48fb1; --theme-color-2: #e91e63;"></div>
                    <span class="theme-name">Rose</span>
                </div>
                <div class="theme-option" onclick="changeTheme('red')">
                    <div class="theme-circle gradient" id="theme-circle-red" style="--theme-color-1: #ef5350; --theme-color-2: #d32f2f;"></div>
                    <span class="theme-name">Rouge</span>
                </div>
                <div class="theme-option" onclick="changeTheme('beige')">
                    <div class="theme-circle gradient" id="theme-circle-beige" style="--theme-color-1: #dcc9a3; --theme-color-2: #8d6e63;"></div>
                    <span class="theme-name">Beige</span>
                </div>
                <div class="theme-option" onclick="changeTheme('lavender')">
                    <div class="theme-circle gradient" id="theme-circle-lavender" style="--theme-color-1: #ce93d8; --theme-color-2: #9c27b0;"></div>
                    <span class="theme-name">Lavande</span>
                </div>
                <div class="theme-option" onclick="changeTheme('peach')">
                    <div class="theme-circle gradient" id="theme-circle-peach" style="--theme-color-1: #ffb74d; --theme-color-2: #ff9800;"></div>
                    <span class="theme-name">Pêche</span>
                </div>
                <div class="theme-option" onclick="changeTheme('mint')">
                    <div class="theme-circle gradient" id="theme-circle-mint" style="--theme-color-1: #4db6ac; --theme-color-2: #00796b;"></div>
                    <span class="theme-name">Menthe</span>
                </div>
            </div>            
            <button class="close-theme-modal-btn" onclick="closeThemeModal()">Fermer</button>
        </div>
    </div>

    <!-- Modal des paramètres -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-modal-content">
            <div class="settings-modal-header">
                <h3>Paramètres</h3>
                <p>Dis-moi si t'en veux d'autres 😽</p>
            </div>
            <div class="user-status-container">
                <div id="connectedUserIndicator" class="connected-user-indicator"></div>
            </div>

            <!-- Contrôles de volume -->
            <div class="volume-settings-section">
                <h4><i class="fas fa-volume-up"></i> Contrôles Audio</h4>
                
                <div class="volume-control-group">
                    <!-- Contrôle musique de fond -->
                    <div class="volume-control-item">
                        <div class="volume-label">Musique</div>
                        <div class="volume-slider-container">
                            <input type="range" 
                                   id="musicVolumeSlider" 
                                   class="volume-slider" 
                                   min="0" 
                                   max="100" 
                                   value="30" 
                                   oninput="updateMusicVolume(this.value)"
                                   onchange="updateMusicVolume(this.value)"
                                   ontouchend="updateMusicVolume(this.value)"
                                   ontouchmove="updateMusicVolume(this.value)">
                            <span id="musicVolumeValue" class="volume-value">30%</span>
                            <button id="musicMuteBtn" 
                                    class="volume-mute-btn" 
                                    onclick="toggleMusicMute()">
                                <i id="musicMuteIcon" class="fas fa-volume-up"></i>
                                <span>ON</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Contrôle effets sonores -->
                    <div class="volume-control-item">
                        <div class="volume-label">Effets</div>
                        <div class="volume-slider-container">
                            <input type="range" 
                                   id="effectsVolumeSlider" 
                                   class="volume-slider" 
                                   min="0" 
                                   max="100" 
                                   value="50" 
                                   oninput="updateEffectsVolume(this.value)"
                                   onchange="updateEffectsVolume(this.value)"
                                   ontouchend="updateEffectsVolume(this.value)"
                                   ontouchmove="updateEffectsVolume(this.value)">
                            <span id="effectsVolumeValue" class="volume-value">50%</span>
                            <button id="effectsMuteBtn" 
                                    class="volume-mute-btn" 
                                    onclick="toggleEffectsMute()">
                                <i id="effectsMuteIcon" class="fas fa-volume-up"></i>
                                <span>ON</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="fonts-grid">
                <div class="font-option active" id="font-option-default" onclick="changeFont('default')">
                    <div class="font-preview" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;">Abc</div>
                    <span class="font-name">Système</span>
                </div>
                <div class="font-option" id="font-option-serif" onclick="changeFont('serif')">
                    <div class="font-preview" style="font-family: Georgia, 'Times New Roman', Times, serif;">Abc</div>
                    <span class="font-name">Serif</span>
                </div>
                <div class="font-option" id="font-option-mono" onclick="changeFont('mono')">
                    <div class="font-preview" style="font-family: 'Courier New', Courier, monospace;">Abc</div>
                    <span class="font-name">Mono</span>
                </div>
                <div class="font-option" id="font-option-cursive" onclick="changeFont('cursive')">
                    <div class="font-preview" style="font-family: 'Comic Sans MS', cursive, sans-serif;">Abc</div>
                    <span class="font-name">Amusant</span>
                </div>
                <div class="font-option" id="font-option-elegant" onclick="changeFont('elegant')">
                    <div class="font-preview" style="font-family: 'Playfair Display', Georgia, serif;">Abc</div>
                    <span class="font-name">Élégant</span>
                </div>
                <div class="font-option" id="font-option-modern" onclick="changeFont('modern')">
                    <div class="font-preview" style="font-family: 'Inter', 'Segoe UI', sans-serif;">Abc</div>
                    <span class="font-name">Moderne</span>
                </div>
                <div class="font-option" id="font-option-handwriting" onclick="changeFont('handwriting')">
                    <div class="font-preview" style="font-family: 'Kalam', cursive, sans-serif;">Abc</div>
                    <span class="font-name">Manuscrit</span>
                </div>
                <div class="font-option" id="font-option-romantic" onclick="changeFont('romantic')">
                    <div class="font-preview" style="font-family: 'Dancing Script', cursive, sans-serif;">Abc</div>
                    <span class="font-name">Romantique</span>
                </div>
                <div class="font-option" id="font-option-minimal" onclick="changeFont('minimal')">
                    <div class="font-preview" style="font-family: 'Poppins', sans-serif;">Abc</div>
                    <span class="font-name">Minimal</span>
                </div>
                <div class="font-option" id="font-option-retro" onclick="changeFont('retro')">
                    <div class="font-preview" style="font-family: 'Orbitron', monospace;">Abc</div>
                    <span class="font-name">Rétro</span>
                </div>
            </div>
            <button class="close-settings-modal-btn" onclick="closeSettingsModal()">Fermer</button>
        </div>
    </div>

    <!-- Modal de confirmation de réinitialisation -->
    <div class="confirmation-modal" id="confirmationModal">
        <div class="confirmation-modal-content">
            <div class="confirmation-modal-header">
                <div class="confirmation-icon">⚠️</div>
                <div class="confirmation-title">Confirmer la réinitialisation</div>
                <div class="confirmation-subtitle">Cette action va remettre tous les scores à zéro. Êtes-vous sûr de vouloir continuer ?</div>
            </div>
            
            <div class="confirmation-buttons">
                <button class="confirmation-button danger" onclick="confirmReset()">
                    <i class="fas fa-trash"></i> Oui, réinitialiser
                </button>
                <button class="confirmation-button" onclick="closeConfirmationModal()">
                    <i class="fas fa-times"></i> Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuration Supabase - REMPLACEZ par vos vraies valeurs
        const SUPABASE_URL = 'https://ocdloxagawjkokiheuiu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jZGxveGFnYXdqa29raWhldWl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MTM1NTQsImV4cCI6MjA2ODA4OTU1NH0.OFC4QyrCKtyY_2JA2I5MnI8JjmuFBYHuJH7nO1Vyu5o';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ID unique pour cette session de jeu (UUID valide)
        const GAME_ID = '550e8400-e29b-41d4-a716-446655440000';

        // Variables pour la musique de fond
        let backgroundMusic = null;
        let isMusicMuted = false;
        let musicVolume = 30; // Volume par défaut de la musique (30%)

        // Variables pour les effets sonores
        let soundEffects = {
            pop: null,
            winning: null,
            losing: null
        };
        let isEffectsMuted = false;
        let effectsVolume = 50; // Volume par défaut des effets (50%)

        // Variables du jeu
        let gameState = {
            board: Array(6).fill().map(() => Array(7).fill(0)), // 0: vide, 1: Benjamin (rouge), 2: Sanaa (jaune)
            currentPlayer: 1, // 1: Benjamin, 2: Sanaa
            gameActive: true,
            winner: null,
            winningCells: [],
            lastMove: null,
            gameId: null,
            scores: { benjamin: 0, sanaa: 0, draws: 0 }
        };

        let isMyTurn = false;
        let currentUser = null;
        let pollInterval = null;

        // Variables pour les clics secrets
        let secretClicks = new Set();
        const secretCells = [
            '2-2', '4-2', // ligne 3: colonnes 3 et 5 (row 2, col 2 et 4)
            '1-3', '3-3', '5-3', // ligne 4: colonnes 2, 4 et 6 (row 3, col 1, 3 et 5)
            '2-4', '4-4', // ligne 5: colonnes 3 et 5 (row 4, col 2 et 4)
            '3-5'  // ligne 6: colonne 4 (row 5, col 3)
        ];

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier l'authentification avant d'initialiser le jeu
            if (!isAuthenticated()) {
                redirectToLogin();
                return;
            }

            // Appliquer le thème sauvegardé
            const savedTheme = localStorage.getItem('selectedTheme') || 'default';
            document.body.classList.add(`theme-${savedTheme}`);
            
            // Marquer le cercle du thème actif
            const activeThemeCircle = document.getElementById(`theme-circle-${savedTheme}`);
            if (activeThemeCircle) {
                document.querySelectorAll('.theme-circle').forEach(circle => {
                    circle.classList.remove('active');
                });
                activeThemeCircle.classList.add('active');
            }
            
            // Appliquer la police enregistrée
            const savedFont = localStorage.getItem('selectedFont') || 'default';
            document.body.classList.add(`font-${savedFont}`);
            
            // Marquer l'option de police active
            const activeFontOption = document.getElementById(`font-option-${savedFont}`);
            if (activeFontOption) {
                document.querySelectorAll('.font-option').forEach(option => {
                    option.classList.remove('active');
                });
                activeFontOption.classList.add('active');
            }

            // Initialiser le jeu
            currentUser = sessionStorage.getItem('currentUser') || 'Benjamin';
            
            // Afficher l'utilisateur connecté
            const userIndicator = document.getElementById('connectedUserIndicator');
            if (userIndicator) {
                // Choisir une icône appropriée selon l'utilisateur
                const userIcon = currentUser === 'Benjamin' ? 
                    '<i class="fas fa-user-circle" style="margin-right: 8px;"></i>' : 
                    '<i class="fas fa-heart" style="margin-right: 8px;"></i>';
                
                // Mise en forme améliorée avec icône
                userIndicator.innerHTML = `${userIcon}Connecté en tant que <strong>${currentUser}</strong>`;
            }
            
            initializeGame();
            setupModalClickOutside(); // Initialiser la fermeture des modals au chargement
            initializeMusic(); // Initialiser la musique de fond
            updateVolumeControls(); // Initialiser les contrôles de volume
            
            // Correction iOS : Ajouter un listener pour le premier clic utilisateur
            if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                document.addEventListener('touchstart', function iOSAudioFix() {
                    // Forcer l'activation de l'audio sur iOS
                    if (backgroundMusic) {
                        backgroundMusic.play().then(() => {
                            backgroundMusic.pause();
                            // Appliquer les paramètres sauvegardés
                            backgroundMusic.volume = isMusicMuted ? 0 : musicVolume / 100;
                        }).catch(e => console.log('iOS audio activation failed:', e));
                    }
                    
                    // Faire de même pour les effets sonores
                    Object.values(soundEffects).forEach(audio => {
                        if (audio) {
                            audio.play().then(() => {
                                audio.pause();
                                audio.currentTime = 0;
                                audio.volume = isEffectsMuted ? 0 : effectsVolume / 100;
                            }).catch(e => console.log('iOS effect activation failed:', e));
                        }
                    });
                    
                    // Supprimer ce listener après la première utilisation
                    document.removeEventListener('touchstart', iOSAudioFix);
                }, { once: true });
            }
        });

        function updateUserIndicator() {
            const userIndicator = document.getElementById('connectedUserIndicator');
            if (userIndicator) {
                const userIcon = currentUser === 'Benjamin' ? 
                    '<i class="fas fa-user-circle" style="margin-right: 8px;"></i>' : 
                    '<i class="fas fa-heart" style="margin-right: 8px;"></i>';
                userIndicator.innerHTML = `${userIcon}Connecté en tant que <strong>${currentUser}</strong>`;
            }
        }

        // Fonction pour mettre à jour l'indicateur de connexion à la base de données
        function updateDatabaseConnectionIndicator(status = 'checking') {
            const indicator = document.getElementById('databaseConnectionIndicator');
            const icon = document.getElementById('connectionStatusIcon');
            const text = document.getElementById('connectionStatusText');
            
            if (!indicator || !icon || !text) return;
            
            // Réinitialiser les classes
            indicator.classList.remove('connected', 'disconnected', 'checking');
            
            // Rendre l'indicateur cliquable pour recharger la partie
            indicator.style.cursor = 'pointer';
            indicator.title = 'Cliquer pour recharger la partie';
            
            // Ajouter l'événement de clic s'il n'existe pas déjà
            if (!indicator.onclick) {
                indicator.onclick = () => {
                    reloadGameFromServer();
                };
            }
            
            switch (status) {
                case 'connected':
                    indicator.classList.add('connected');
                    icon.className = 'fas fa-circle';
                    text.textContent = 'DB ✓';
                    break;
                case 'disconnected':
                    indicator.classList.add('disconnected');
                    icon.className = 'fas fa-circle';
                    text.textContent = 'DB ✗';
                    break;
                case 'checking':
                default:
                    indicator.classList.add('checking');
                    icon.className = 'fas fa-circle';
                    text.textContent = 'DB...';
                    break;
            }
        }

        // Fonction pour vérifier la connexion à Supabase
        async function checkDatabaseConnection() {
            try {
                updateDatabaseConnectionIndicator('checking');
                
                // Test simple de connexion à Supabase
                const { data, error } = await supabase
                    .from('puissance4_games')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    console.log('Erreur de connexion DB:', error.message);
                    updateDatabaseConnectionIndicator('disconnected');
                    return false;
                } else {
                    updateDatabaseConnectionIndicator('connected');
                    return true;
                }
            } catch (error) {
                console.log('Erreur lors du test de connexion:', error);
                updateDatabaseConnectionIndicator('disconnected');
                return false;
            }
        }

        // ===== Gestion de la musique de fond =====
        function initializeMusic() {
            try {
                // Créer l'élément audio pour la musique de fond
                backgroundMusic = new Audio('Son/Tetoma.mp3');
                backgroundMusic.loop = true;
                backgroundMusic.volume = musicVolume / 100; // Convertir en pourcentage
                backgroundMusic.preload = 'auto'; // Précharger la musique
                
                // Créer les éléments audio pour les effets sonores
                soundEffects.pop = new Audio('Son/pop.mp3');
                soundEffects.winning = new Audio('Son/winning.mp3');
                soundEffects.losing = new Audio('Son/losing.mp3');
                
                // Précharger tous les effets sonores
                Object.values(soundEffects).forEach(audio => {
                    if (audio) {
                        audio.preload = 'auto';
                        audio.volume = effectsVolume / 100;
                    }
                });
                
                // Forcer le chargement des fichiers audio
                const loadPromises = [];
                
                // Charger la musique de fond
                loadPromises.push(new Promise((resolve) => {
                    backgroundMusic.addEventListener('canplaythrough', resolve, { once: true });
                    backgroundMusic.addEventListener('error', () => {
                        console.error('Erreur de chargement de la musique de fond');
                        resolve();
                    }, { once: true });
                    backgroundMusic.load();
                }));
                
                // Charger les effets sonores
                Object.entries(soundEffects).forEach(([name, audio]) => {
                    if (audio) {
                        loadPromises.push(new Promise((resolve) => {
                            audio.addEventListener('canplaythrough', resolve, { once: true });
                            audio.addEventListener('error', () => {
                                console.error(`Erreur de chargement de l'effet sonore: ${name}`);
                                resolve();
                            }, { once: true });
                            audio.load();
                        }));
                    }
                });
                
                // Attendre que tous les fichiers soient chargés
                Promise.all(loadPromises).then(() => {
                    console.log('Tous les fichiers audio sont chargés et prêts !');
                });
                
                // Récupérer les états sauvegardés depuis localStorage
                isMusicMuted = localStorage.getItem('musicMuted') === 'true';
                isEffectsMuted = localStorage.getItem('effectsMuted') === 'true';
                
                const savedMusicVolume = localStorage.getItem('musicVolume');
                if (savedMusicVolume) {
                    musicVolume = parseInt(savedMusicVolume);
                    const finalMusicVolume = isMusicMuted ? 0 : musicVolume / 100;
                    backgroundMusic.volume = finalMusicVolume;
                    
                    // Correction iOS : Forcer la mise à jour du volume
                    if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                        setTimeout(() => {
                            backgroundMusic.volume = finalMusicVolume;
                        }, 100);
                    }
                }
                
                const savedEffectsVolume = localStorage.getItem('effectsVolume');
                if (savedEffectsVolume) {
                    effectsVolume = parseInt(savedEffectsVolume);
                    Object.values(soundEffects).forEach(audio => {
                        if (audio) {
                            const finalEffectsVolume = isEffectsMuted ? 0 : effectsVolume / 100;
                            audio.volume = finalEffectsVolume;
                            
                            // Correction iOS : Forcer la mise à jour du volume
                            if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                                setTimeout(() => {
                                    audio.volume = finalEffectsVolume;
                                }, 100);
                            }
                        }
                    });
                }
                
                // Mettre à jour l'interface
                updateMusicButtonIcon();
                
                console.log('Audio initialisé avec succès');
            } catch (error) {
                console.error('Erreur lors de l\'initialisation de l\'audio:', error);
            }
        }

        function startBackgroundMusic() {
            if (backgroundMusic && !isMusicMuted) {
                try {
                    // Les navigateurs modernes nécessitent une interaction utilisateur pour jouer de l'audio
                    const playPromise = backgroundMusic.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('Musique de fond démarrée');
                        }).catch(error => {
                            console.log('Impossible de démarrer la musique automatiquement:', error);
                        });
                    }
                } catch (error) {
                    console.error('Erreur lors du démarrage de la musique:', error);
                }
            }
        }

        function stopBackgroundMusic() {
            if (backgroundMusic) {
                try {
                    backgroundMusic.pause();
                    backgroundMusic.currentTime = 0;
                    console.log('Musique de fond arrêtée');
                } catch (error) {
                    console.error('Erreur lors de l\'arrêt de la musique:', error);
                }
            }
        }

        function toggleMusic() {
            toggleMusicMute(); // Utiliser la nouvelle fonction de mute
        }

        function updateMusicButtonIcon() {
            const musicIcon = document.getElementById('musicIcon');
            const musicBtn = document.getElementById('musicBtn');
            
            if (musicIcon && musicBtn) {
                if (isMusicMuted) {
                    musicIcon.className = 'fas fa-volume-mute';
                    musicBtn.classList.add('muted');
                } else {
                    musicIcon.className = 'fas fa-volume-up';
                    musicBtn.classList.remove('muted');
                }
            }
        }

        // ===== Fonctions pour les contrôles de volume =====
        function updateVolumeControls() {
            // Mettre à jour les sliders avec les valeurs sauvegardées
            const musicSlider = document.getElementById('musicVolumeSlider');
            const effectsSlider = document.getElementById('effectsVolumeSlider');
            const musicValue = document.getElementById('musicVolumeValue');
            const effectsValue = document.getElementById('effectsVolumeValue');
            
            if (musicSlider) musicSlider.value = musicVolume;
            if (effectsSlider) effectsSlider.value = effectsVolume;
            if (musicValue) musicValue.textContent = musicVolume + '%';
            if (effectsValue) effectsValue.textContent = effectsVolume + '%';
            
            // Mettre à jour les boutons mute
            updateMusicMuteButton();
            updateEffectsMuteButton();
            
            // Correction iOS : Appliquer immédiatement les volumes aux éléments audio
            if (backgroundMusic) {
                const finalMusicVolume = isMusicMuted ? 0 : musicVolume / 100;
                backgroundMusic.volume = finalMusicVolume;
                
                // Forcer la mise à jour sur iOS
                if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                    setTimeout(() => {
                        backgroundMusic.volume = finalMusicVolume;
                    }, 50);
                }
            }
            
            // Appliquer les volumes aux effets sonores
            Object.values(soundEffects).forEach(audio => {
                if (audio) {
                    const finalEffectsVolume = isEffectsMuted ? 0 : effectsVolume / 100;
                    audio.volume = finalEffectsVolume;
                    
                    // Forcer la mise à jour sur iOS
                    if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                        setTimeout(() => {
                            audio.volume = finalEffectsVolume;
                        }, 50);
                    }
                }
            });
            
            // S'assurer que les contrôles sont visibles sur mobile
            requestAnimationFrame(() => {
                const volumeSection = document.querySelector('.volume-settings-section');
                if (volumeSection && window.innerWidth <= 768) {
                    volumeSection.style.display = 'block';
                    volumeSection.style.width = '100%';
                    volumeSection.style.boxSizing = 'border-box';
                }
            });
        }

        function updateMusicVolume(value) {
            musicVolume = parseInt(value);
            const musicValue = document.getElementById('musicVolumeValue');
            if (musicValue) {
                musicValue.textContent = musicVolume + '%';
                musicValue.classList.add('value-updated');
                setTimeout(() => {
                    musicValue.classList.remove('value-updated');
                }, 300);
            }
            
            // Correction pour iOS : Appliquer le volume même si muté pour iPhone
            if (backgroundMusic) {
                const finalVolume = isMusicMuted ? 0 : musicVolume / 100;
                backgroundMusic.volume = finalVolume;
                
                // Forcer la mise à jour sur iOS en créant un bref changement
                if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                    backgroundMusic.volume = finalVolume === 0 ? 0.001 : finalVolume;
                    setTimeout(() => {
                        backgroundMusic.volume = finalVolume;
                    }, 10);
                }
            }
            
            localStorage.setItem('musicVolume', musicVolume.toString());
        }

        function updateEffectsVolume(value) {
            effectsVolume = parseInt(value);
            const effectsValue = document.getElementById('effectsVolumeValue');
            if (effectsValue) {
                effectsValue.textContent = effectsVolume + '%';
                effectsValue.classList.add('value-updated');
                setTimeout(() => {
                    effectsValue.classList.remove('value-updated');
                }, 300);
            }
            
            // Correction pour iOS : Mettre à jour tous les effets sonores
            Object.values(soundEffects).forEach(audio => {
                if (audio) {
                    const finalVolume = isEffectsMuted ? 0 : effectsVolume / 100;
                    audio.volume = finalVolume;
                    
                    // Forcer la mise à jour sur iOS
                    if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                        audio.volume = finalVolume === 0 ? 0.001 : finalVolume;
                        setTimeout(() => {
                            audio.volume = finalVolume;
                        }, 10);
                    }
                }
            });
            
            localStorage.setItem('effectsVolume', effectsVolume.toString());
        }

        function toggleMusicMute() {
            isMusicMuted = !isMusicMuted;
            localStorage.setItem('musicMuted', isMusicMuted.toString());
            
            if (backgroundMusic) {
                const finalVolume = isMusicMuted ? 0 : musicVolume / 100;
                backgroundMusic.volume = finalVolume;
                
                // Correction spécifique pour iOS
                if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                    if (isMusicMuted) {
                        // Pour muter sur iOS, on pause ET on met le volume à 0
                        backgroundMusic.volume = 0;
                        backgroundMusic.pause();
                    } else {
                        // Pour démuter sur iOS, on remet le volume ET on redémarre si nécessaire
                        backgroundMusic.volume = musicVolume / 100;
                        if (gameState.gameActive && !gameState.winner) {
                            backgroundMusic.play().catch(e => console.log('Erreur lecture iOS:', e));
                        }
                    }
                } else {
                    // Comportement standard pour les autres navigateurs
                    if (!isMusicMuted && gameState.gameActive && backgroundMusic.paused) {
                        startBackgroundMusic();
                    } else if (isMusicMuted && !backgroundMusic.paused) {
                        backgroundMusic.pause();
                    }
                }
            }
            
            updateMusicMuteButton();
            updateMusicButtonIcon(); // Mettre à jour aussi le bouton principal
        }

        function toggleEffectsMute() {
            isEffectsMuted = !isEffectsMuted;
            localStorage.setItem('effectsMuted', isEffectsMuted.toString());
            
            // Correction pour iOS : Mise à jour forcée des volumes des effets sonores
            Object.values(soundEffects).forEach(audio => {
                if (audio) {
                    const finalVolume = isEffectsMuted ? 0 : effectsVolume / 100;
                    audio.volume = finalVolume;
                    
                    // Forcer la mise à jour sur iOS
                    if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                        audio.volume = finalVolume === 0 ? 0.001 : finalVolume;
                        setTimeout(() => {
                            audio.volume = finalVolume;
                        }, 10);
                    }
                }
            });
            
            updateEffectsMuteButton();

            // Jouer un son de test si pas muté (avec délai pour iOS)
            if (!isEffectsMuted) {
                setTimeout(() => {
                    playSound('pop');
                }, 100);
            }
        }

        function updateMusicMuteButton() {
            const musicMuteBtn = document.getElementById('musicMuteBtn');
            const musicMuteIcon = document.getElementById('musicMuteIcon');
            
            if (musicMuteBtn && musicMuteIcon) {
                if (isMusicMuted) {
                    musicMuteBtn.classList.add('muted');
                    musicMuteIcon.className = 'fas fa-volume-mute';
                } else {
                    musicMuteBtn.classList.remove('muted');
                    musicMuteIcon.className = 'fas fa-volume-up';
                }
            }
        }

        function updateEffectsMuteButton() {
            const effectsMuteBtn = document.getElementById('effectsMuteBtn');
            const effectsMuteIcon = document.getElementById('effectsMuteIcon');
            
            if (effectsMuteBtn && effectsMuteIcon) {
                if (isEffectsMuted) {
                    effectsMuteBtn.classList.add('muted');
                    effectsMuteIcon.className = 'fas fa-volume-mute';
                } else {
                    effectsMuteBtn.classList.remove('muted');
                    effectsMuteIcon.className = 'fas fa-volume-up';
                }
            }
        }

        function playSound(soundName) {
            if (!soundEffects[soundName] || isEffectsMuted) {
                return;
            }
            
            try {
                const audio = soundEffects[soundName];
                audio.currentTime = 0;
                audio.volume = effectsVolume / 100;
                audio.play().catch(error => {
                    // Ignore errors silently
                });
            } catch (error) {
                // Ignore errors silently
            }
        }

        function playSoundBasedOnResult() {
            if (!gameState.gameActive) {
                setTimeout(() => {
                    if (gameState.winner === 0) {
                        // Égalité - pas de son spécial
                        return;
                    } else if (gameState.winner === 1 && currentUser === 'Benjamin') {
                        // Benjamin gagne et c'est Benjamin qui joue
                        playSound('winning');
                    } else if (gameState.winner === 2 && currentUser === 'Sanaa') {
                        // Sanaa gagne et c'est Sanaa qui joue
                        playSound('winning');
                    } else {
                        // L'autre joueur gagne - son de défaite
                        playSound('losing');
                    }
                }, 100);
            }
        }

        // Initialisation du jeu
        function initializeGame() {
            createBoard();
            checkDatabaseConnection(); // Vérifier la connexion DB au démarrage
            loadGameFromServer();
            setupRealTimeSubscription(); // Remplace le polling par du temps réel
            
            // Force la mise à jour après un court délai pour éviter les bugs visuels
            setTimeout(() => {
                updateColumnIndicators();
                updateGameStatus();
            }, 100);
        }

        // Créer le plateau de jeu
        function createBoard() {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';
            
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 7; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'game-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    // Ajouter les événements de clic et hover directement sur chaque cellule
                    cell.addEventListener('click', (e) => {
                        // D'abord vérifier les clics secrets
                        const wasSecretClick = handleSecretClick(row, col, e);
                        // Puis gérer le clic normal de colonne seulement si ce n'était pas un clic secret
                        if (!wasSecretClick) {
                            handleColumnClick(col);
                        }
                    });
                    cell.addEventListener('mouseenter', () => handleColumnHover(col, true));
                    cell.addEventListener('mouseleave', () => handleColumnHover(col, false));
                    
                    board.appendChild(cell);
                }
            }

            // Ajouter les événements de hover sur les indicateurs de colonnes
            const indicators = document.querySelectorAll('.column-indicator');
            indicators.forEach((indicator, col) => {
                indicator.addEventListener('mouseenter', () => handleColumnHover(col, true));
                indicator.addEventListener('mouseleave', () => handleColumnHover(col, false));
            });
        }

        // Gestion des clics secrets
        function handleSecretClick(row, col, event) {
            const cellKey = `${col}-${row}`;
            
            // Vérifier si cette cellule fait partie des cellules secrètes
            if (secretCells.includes(cellKey)) {
                // Si le jeu est terminé OU que ce n'est pas le tour du joueur, gérer le clic secret
                if (!gameState.gameActive || !isMyTurn) {
                    event.stopPropagation(); // Empêcher le clic normal
                    
                    // Ajouter le clic à notre set
                    secretClicks.add(cellKey);
                    
                    // Ajouter le contour pointillé à la cellule
                    const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                    if (cell) {
                        cell.classList.add('secret-border');
                    }
                    
                    // Vérifier si toutes les cellules secrètes ont été cliquées
                    if (secretClicks.size === secretCells.length) {
                        showHeartGif();
                        // Réinitialiser après l'affichage
                        setTimeout(() => {
                            resetSecretClicks();
                        }, 3000);
                    }
                    
                    return true; // Indique que c'était un clic secret
                }
            } else {
                // Si une cellule non-secrète est cliquée, réinitialiser les clics secrets
                if (secretClicks.size > 0) {
                    resetSecretClicks();
                }
            }
            
            return false; // Pas un clic secret ou conditions non remplies
        }

        // Afficher l'explosion de gifs coeur
        function showHeartGif() {
            // Supprimer tous les gifs existants
            const existingGifs = document.querySelectorAll('.heart-gif');
            existingGifs.forEach(gif => gif.remove());
            
            // Créer une explosion de 15 cœurs partout sur l'écran
            const numberOfHearts = 15;
            
            // Taille de l'écran
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            
            for (let i = 0; i < numberOfHearts; i++) {
                const heartGif = document.createElement('img');
                heartGif.src = 'images/coeur3.gif';
                heartGif.className = 'heart-gif heart-explosion';
                heartGif.alt = 'Coeur';
                
                // Position aléatoire sur tout l'écran
                const startX = Math.random() * screenWidth;
                const startY = Math.random() * screenHeight;
                
                // Styles sans bordure
                heartGif.style.position = 'fixed';
                heartGif.style.left = startX + 'px';
                heartGif.style.top = startY + 'px';
                heartGif.style.width = (40 + Math.random() * 40) + 'px'; // Taille variable 40-80px
                heartGif.style.height = 'auto';
                heartGif.style.zIndex = '10000';
                heartGif.style.pointerEvents = 'none';
                heartGif.style.transform = 'scale(0) rotate(0deg)';
                heartGif.style.transition = 'all 2.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                heartGif.style.opacity = '0';
                heartGif.style.border = 'none';
                heartGif.style.outline = 'none';
                heartGif.style.boxShadow = 'none';
                
                // Ajouter au body
                document.body.appendChild(heartGif);
                
                // Animation d'apparition et mouvement
                setTimeout(() => {
                    const finalScale = 1 + Math.random() * 0.8; // Scale entre 1 et 1.8
                    const finalRotation = Math.random() * 720 - 360; // Rotation entre -360 et 360
                    const moveX = (Math.random() - 0.5) * 300; // Mouvement horizontal
                    const moveY = (Math.random() - 0.5) * 300; // Mouvement vertical
                    
                    heartGif.style.transform = `translate(${moveX}px, ${moveY}px) scale(${finalScale}) rotate(${finalRotation}deg)`;
                    heartGif.style.opacity = '0.9';
                }, 50 + i * 80); // Délai échelonné
                
                // Faire disparaître chaque cœur
                setTimeout(() => {
                    heartGif.style.opacity = '0';
                    heartGif.style.transform += ' scale(0.2)';
                }, 2000 + i * 80);
                
                // Supprimer du DOM
                setTimeout(() => {
                    if (heartGif && heartGif.parentNode) {
                        heartGif.remove();
                    }
                }, 4000 + i * 80);
            }
            
            // Ajouter quelques cœurs géants qui traversent l'écran
            for (let j = 0; j < 3; j++) {
                setTimeout(() => {
                    const giantHeart = document.createElement('img');
                    giantHeart.src = 'images/coeur3.gif';
                    giantHeart.className = 'heart-gif heart-giant';
                    giantHeart.alt = 'Coeur Géant';
                    
                    const startSide = Math.floor(Math.random() * 4); // 0=gauche, 1=droite, 2=haut, 3=bas
                    let startX, startY, endX, endY;
                    
                    if (startSide === 0) { // De la gauche
                        startX = -100;
                        startY = Math.random() * screenHeight;
                        endX = screenWidth + 100;
                        endY = Math.random() * screenHeight;
                    } else if (startSide === 1) { // De la droite
                        startX = screenWidth + 100;
                        startY = Math.random() * screenHeight;
                        endX = -100;
                        endY = Math.random() * screenHeight;
                    } else if (startSide === 2) { // Du haut
                        startX = Math.random() * screenWidth;
                        startY = -100;
                        endX = Math.random() * screenWidth;
                        endY = screenHeight + 100;
                    } else { // Du bas
                        startX = Math.random() * screenWidth;
                        startY = screenHeight + 100;
                        endX = Math.random() * screenWidth;
                        endY = -100;
                    }
                    
                    giantHeart.style.position = 'fixed';
                    giantHeart.style.left = startX + 'px';
                    giantHeart.style.top = startY + 'px';
                    giantHeart.style.width = '120px';
                    giantHeart.style.height = 'auto';
                    giantHeart.style.zIndex = '9999';
                    giantHeart.style.pointerEvents = 'none';
                    giantHeart.style.opacity = '0.8';
                    giantHeart.style.transition = 'all 3s linear';
                    giantHeart.style.border = 'none';
                    giantHeart.style.outline = 'none';
                    giantHeart.style.boxShadow = 'none';
                    giantHeart.style.filter = 'brightness(1.3) saturate(1.2)';
                    
                    document.body.appendChild(giantHeart);
                    
                    // Mouvement de traversée
                    setTimeout(() => {
                        giantHeart.style.left = endX + 'px';
                        giantHeart.style.top = endY + 'px';
                        giantHeart.style.transform = `rotate(${Math.random() * 360}deg)`;
                    }, 100);
                    
                    // Supprimer après la traversée
                    setTimeout(() => {
                        if (giantHeart && giantHeart.parentNode) {
                            giantHeart.remove();
                        }
                    }, 3500);
                }, j * 1000);
            }
        }

        // Réinitialiser les clics secrets
        function resetSecretClicks() {
            secretClicks.clear();
            
            // Supprimer tous les contours pointillés
            document.querySelectorAll('.secret-border').forEach(cell => {
                cell.classList.remove('secret-border');
            });
        }

        // Gestion du hover sur une colonne
        function handleColumnHover(col, isHovering) {
            // Hover désactivé - pas d'effets visuels
            return;
        }

        // Gestion du clic sur une colonne
        function handleColumnClick(col) {
            if (!gameState.gameActive || !isMyTurn) {
                showNotification('Ce n\'est pas votre tour !', 'warning');
                return;
            }

            const playerNumber = currentUser === 'Benjamin' ? 1 : 2;
            if (gameState.currentPlayer !== playerNumber) {
                showNotification('Ce n\'est pas votre tour !', 'warning');
                return;
            }

            if (makeMove(col)) {
                saveGameToServer();
            }
        }

        // Effectuer un mouvement
        function makeMove(col) {
            // Trouver la ligne la plus basse disponible
            let targetRow = -1;
            for (let row = 5; row >= 0; row--) {
                if (gameState.board[row][col] === 0) {
                    targetRow = row;
                    break;
                }
            }

            if (targetRow === -1) {
                showNotification('Cette colonne est pleine !', 'warning');
                return false;
            }

            // Placer le pion
            gameState.board[targetRow][col] = gameState.currentPlayer;
            gameState.lastMove = { row: targetRow, col: col, player: gameState.currentPlayer };
            
            // Jouer le son du pion qui tombe
            playSound('pop');
            
            // Animer le pion qui tombe
            animateDroppingPiece(targetRow, col, gameState.currentPlayer);
            
            // Vérifier la victoire
            if (checkWin(targetRow, col)) {
                gameState.gameActive = false;
                gameState.winner = gameState.currentPlayer;
                highlightWinningCells();
                updateScores();
                updateGameStatus();
                stopBackgroundMusic(); // Arrêter la musique à la fin de la partie
                playSoundBasedOnResult(); // Jouer le son de victoire/défaite
                showVictoryModal(); // Remplace showNotification
            } else if (checkDraw()) {
                gameState.gameActive = false;
                gameState.winner = 0; // Égalité
                updateScores();
                updateGameStatus();
                stopBackgroundMusic(); // Arrêter la musique à la fin de la partie
                showVictoryModal(); // Remplace showNotification
            } else {
                // Changer de joueur
                gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
                updateGameStatus();
            }

            updateBoard();
            return true;
        }

        // Animer le pion qui tombe
        function animateDroppingPiece(row, col, player) {
            const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            cell.classList.add('dropping');
            cell.classList.add(player === 1 ? 'red' : 'yellow');
            cell.classList.add('occupied');
            
            setTimeout(() => {
                cell.classList.remove('dropping');
            }, 500);
        }

        // Vérifier la victoire
        function checkWin(row, col) {
            const player = gameState.board[row][col];
            const directions = [
                [0, 1],   // Horizontal
                [1, 0],   // Vertical
                [1, 1],   // Diagonal /
                [1, -1]   // Diagonal \
            ];

            for (let [dr, dc] of directions) {
                let count = 1;
                let winningCells = [{row, col}];
                
                // Vérifier dans une direction
                for (let i = 1; i < 4; i++) {
                    const newRow = row + dr * i;
                    const newCol = col + dc * i;
                    if (newRow >= 0 && newRow < 6 && newCol >= 0 && newCol < 7 && 
                        gameState.board[newRow][newCol] === player) {
                        count++;
                        winningCells.push({row: newRow, col: newCol});
                    } else {
                        break;
                    }
                }
                
                // Vérifier dans la direction opposée
                for (let i = 1; i < 4; i++) {
                    const newRow = row - dr * i;
                    const newCol = col - dc * i;
                    if (newRow >= 0 && newRow < 6 && newCol >= 0 && newCol < 7 && 
                        gameState.board[newRow][newCol] === player) {
                        count++;
                        winningCells.push({row: newRow, col: newCol});
                    } else {
                        break;
                    }
                }
                
                if (count >= 4) {
                    gameState.winningCells = winningCells;
                    return true;
                }
            }
            
            return false;
        }

        // Vérifier l'égalité
        function checkDraw() {
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 7; col++) {
                    if (gameState.board[row][col] === 0) {
                        return false;
                    }
                }
            }
            return true;
        }

        // Mettre en évidence les cellules gagnantes
        function highlightWinningCells() {
            gameState.winningCells.forEach(({row, col}) => {
                const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                setTimeout(() => {
                    cell.classList.add('winning');
                }, 600);
            });
        }

        // Mettre à jour l'affichage du plateau
        function updateBoard(animateLastMove = false) {
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 7; col++) {
                    const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                    const value = gameState.board[row][col];
                    
                    // Réinitialiser les classes
                    cell.classList.remove('red', 'yellow', 'occupied', 'winning', 'last-move');
                    
                    if (value === 1) {
                        cell.classList.add('red', 'occupied');
                    } else if (value === 2) {
                        cell.classList.add('yellow', 'occupied');
                    }
                    
                    // Appliquer le contour sur le dernier pion joué
                    if (gameState.lastMove && 
                        row === gameState.lastMove.row && 
                        col === gameState.lastMove.col) {
                        cell.classList.add('last-move');
                        
                        // Animer le dernier pion si demandé (pour l'adversaire)
                        if (animateLastMove) {
                            cell.classList.add('dropping');
                            setTimeout(() => {
                                cell.classList.remove('dropping');
                            }, 500);
                        }
                    }
                }
            }
            
            // Remettre en évidence les cellules gagnantes si nécessaire
            if (gameState.winningCells.length > 0) {
                highlightWinningCells();
            }

            // Mettre à jour les indicateurs de colonnes
            updateColumnIndicators();
        }

        // Mettre à jour les indicateurs de colonnes
        function updateColumnIndicators() {
            const indicators = document.querySelectorAll('.column-indicator');
            
            indicators.forEach((indicator, col) => {
                // Vérifier si la colonne est pleine
                const isColumnFull = gameState.board[0][col] !== 0;
                
                // Réinitialiser complètement tous les styles
                indicator.classList.remove('disabled', 'full', 'hover-active');
                indicator.style.cssText = ''; // Reset all inline styles
                
                if (!gameState.gameActive) {
                    // Jeu terminé - style neutre
                    indicator.style.cursor = 'not-allowed';
                    indicator.style.opacity = '0.5';
                    indicator.style.background = 'rgba(255, 255, 255, 0.1)';
                    indicator.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                } else if (!isMyTurn) {
                    // Pas notre tour - style d'attente
                    indicator.style.cursor = 'not-allowed';
                    indicator.style.opacity = '0.4';
                    indicator.style.background = 'rgba(255, 255, 255, 0.05)';
                    indicator.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                } else if (isColumnFull) {
                    // Colonne pleine - style rouge
                    indicator.classList.add('full');
                    indicator.style.cursor = 'not-allowed';
                    indicator.style.opacity = '0.6';
                    indicator.style.background = 'rgba(255, 100, 100, 0.2)';
                    indicator.style.borderColor = 'rgba(255, 100, 100, 0.4)';
                } else {
                    // Colonne jouable - style actif
                    indicator.style.cursor = 'pointer';
                    indicator.style.opacity = '0.8';
                    indicator.style.background = 'rgba(255, 255, 255, 0.2)';
                    indicator.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                    indicator.style.transition = 'all 0.2s ease';
                }
            });

            // Mettre à jour l'état des cellules
            const cells = document.querySelectorAll('.game-cell');
            cells.forEach(cell => {
                const col = parseInt(cell.dataset.col);
                const isColumnFull = gameState.board[0][col] !== 0;
                
                // Reset des classes hover
                cell.classList.remove('column-hover');
                
                if (!gameState.gameActive || !isMyTurn || isColumnFull) {
                    cell.style.cursor = 'not-allowed';
                } else {
                    cell.style.cursor = 'pointer';
                }
            });
        }

        // Mettre à jour le statut du jeu
        function updateGameStatus() {
            const statusElement = document.getElementById('gameStatus');
            const benjaminCard = document.getElementById('benjaminCard');
            const sanaaCard = document.getElementById('sanaaCard');
            
            // Réinitialiser les cartes actives
            benjaminCard.classList.remove('active');
            sanaaCard.classList.remove('active');
            
            // Retirer les anciens événements de clic
            statusElement.onclick = null;
            statusElement.style.cursor = 'default';
            
            if (!gameState.gameActive) {
                if (gameState.winner === 1) {
                    statusElement.textContent = 'Benjamin gagne ! 🔴';
                    benjaminCard.classList.add('active');
                } else if (gameState.winner === 2) {
                    statusElement.textContent = 'Sanaa gagne ! 🟡';
                    sanaaCard.classList.add('active');
                } else {
                    statusElement.textContent = 'Égalité ! 🤝';
                }
                
                // Rendre le statut cliquable pour rouvrir le modal de victoire
                statusElement.style.cursor = 'pointer';
                statusElement.title = 'Cliquer pour voir les détails de la victoire';
                statusElement.onclick = () => {
                    showVictoryModal();
                };
            } else {
                if (gameState.currentPlayer === 1) {
                    statusElement.textContent = 'Au tour de Benjamin 🔴';
                    benjaminCard.classList.add('active');
                    isMyTurn = (currentUser === 'Benjamin');
                } else {
                    statusElement.textContent = 'Au tour de Sanaa 🟡';
                    sanaaCard.classList.add('active');
                    isMyTurn = (currentUser === 'Sanaa');
                }
            }

            // Mettre à jour les indicateurs de colonnes
            updateColumnIndicators();
        }

        // Mettre à jour les scores
        function updateScores() {
            if (gameState.winner === 1) {
                gameState.scores.benjamin++;
            } else if (gameState.winner === 2) {
                gameState.scores.sanaa++;
            } else {
                gameState.scores.draws++;
            }
            
            document.getElementById('benjaminScore').textContent = gameState.scores.benjamin;
            document.getElementById('sanaaScore').textContent = gameState.scores.sanaa;
            document.getElementById('drawScore').textContent = gameState.scores.draws;
        }

        // Démarrer une nouvelle partie
        function startNewGame() {
            gameState.board = Array(6).fill().map(() => Array(7).fill(0));
            gameState.currentPlayer = Math.random() < 0.5 ? 1 : 2; // Choix aléatoire du premier joueur
            gameState.gameActive = true;
            gameState.winner = null;
            gameState.winningCells = [];
            gameState.lastMove = null;
            gameState.gameId = Date.now().toString();
            
            // Réinitialiser les clics secrets
            resetSecretClicks();
            
            updateBoard();
            updateGameStatus();
            saveGameToServer();
            
            // Démarrer la musique de fond si elle n'est pas coupée
            startBackgroundMusic();
            
            const firstPlayer = gameState.currentPlayer === 1 ? 'Benjamin' : 'Sanaa';
            showNotification(`Nouvelle partie commencée ! ${firstPlayer} commence `, 'success');
        }

        // Réinitialiser le jeu (affiche le modal de confirmation)
        function resetGame() {
            showConfirmationModal();
        }

        // Fonctions pour le modal de confirmation
        function showConfirmationModal() {
            const modal = document.getElementById('confirmationModal');
            
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
            }, 50);
        }

        function closeConfirmationModal() {
            const modal = document.getElementById('confirmationModal');
            
            modal.classList.add('closing');
            setTimeout(() => {
                modal.classList.remove('show', 'closing');
                modal.style.display = 'none';
            }, 300);
        }
        function confirmReset() {
            // Fermer le modal
            closeConfirmationModal();
            
            // Réinitialiser après une petite pause
            setTimeout(() => {
                gameState.scores = { benjamin: 0, sanaa: 0, draws: 0 };
                document.getElementById('benjaminScore').textContent = '0';
                document.getElementById('sanaaScore').textContent = '0';
                document.getElementById('drawScore').textContent = '0';
                startNewGame();
                showNotification('Scores réinitialisés !', 'info');
            }, 200);
        }

        // Sauvegarder le jeu sur Supabase
        async function saveGameToServer() {
            try {
                const { data, error } = await supabase
                    .from('puissance4_games')
                    .upsert({
                        id: GAME_ID,
                        game_state: gameState,
                        last_update: new Date().toISOString(),
                        last_player: currentUser
                    });

                if (error) {
                    throw error;
                }
                
                updateDatabaseConnectionIndicator('connected');
                console.log('Jeu sauvegardé avec succès');
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                updateDatabaseConnectionIndicator('disconnected');
                showNotification('Erreur de synchronisation', 'error');
            }
        }

        // Charger le jeu depuis Supabase
        async function loadGameFromServer() {
            try {
                const { data, error } = await supabase
                    .from('puissance4_games')
                    .select('*')
                    .eq('id', GAME_ID)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
                    throw error;
                }

                if (data && data.game_state) {
                    gameState = data.game_state;
                    updateBoard();
                    updateGameStatus();
                    updateColumnIndicators(); // Force la mise à jour des indicateurs
                    document.getElementById('benjaminScore').textContent = gameState.scores.benjamin;
                    document.getElementById('sanaaScore').textContent = gameState.scores.sanaa;
                    document.getElementById('drawScore').textContent = gameState.scores.draws;
                    
                    // Si une partie est en cours, démarrer la musique
                    if (gameState.gameActive) {
                        startBackgroundMusic();
                    }
                } else {
                    // Première fois - initialiser le jeu
                    startNewGame();
                }
                
                updateDatabaseConnectionIndicator('connected');
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
                updateDatabaseConnectionIndicator('disconnected');
                showNotification('Erreur de connexion', 'error');
                // Initialiser un nouveau jeu en cas d'erreur
                startNewGame();
            }
        }

        // Fonction pour recharger manuellement la partie depuis la base de données
        async function reloadGameFromServer() {
            showNotification('Rechargement de la partie...', 'info');
            updateDatabaseConnectionIndicator('checking');
            
            try {
                const { data, error } = await supabase
                    .from('puissance4_games')
                    .select('*')
                    .eq('id', GAME_ID)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (data && data.game_state) {
                    gameState = data.game_state;
                    updateBoard();
                    updateGameStatus();
                    updateColumnIndicators();
                    document.getElementById('benjaminScore').textContent = gameState.scores.benjamin;
                    document.getElementById('sanaaScore').textContent = gameState.scores.sanaa;
                    document.getElementById('drawScore').textContent = gameState.scores.draws;
                    
                    // Gérer la musique selon l'état du jeu
                    if (gameState.gameActive && !backgroundMusic.currentTime) {
                        startBackgroundMusic();
                    } else if (!gameState.gameActive && backgroundMusic && !backgroundMusic.paused) {
                        stopBackgroundMusic();
                    }
                    
                } else {
                    startNewGame();
                }
                
                updateDatabaseConnectionIndicator('connected');
            } catch (error) {
                console.error('Erreur lors du rechargement:', error);
                updateDatabaseConnectionIndicator('disconnected');
                showNotification('Erreur lors du rechargement de la partie', 'error');
            }
        }

        // Écouter les changements en temps réel
        function setupRealTimeSubscription() {
            const subscription = supabase
                .channel('puissance4-changes')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'puissance4_games',
                        filter: `id=eq.${GAME_ID}`
                    },
                    (payload) => {
                        if (payload.new && payload.new.game_state) {
                            const previousGameState = { ...gameState };
                            
                            // Ne pas recharger si c'est nous qui avons fait le changement
                            if (payload.new.last_player !== currentUser) {
                                const previousLastMove = gameState.lastMove;
                                gameState = payload.new.game_state;
                                
                                // Vérifier s'il y a un nouveau coup à animer
                                const shouldAnimate = gameState.lastMove && 
                                    (!previousLastMove || 
                                     previousLastMove.row !== gameState.lastMove.row || 
                                     previousLastMove.col !== gameState.lastMove.col);
                                
                                // Jouer le son "pop" quand l'adversaire joue
                                if (shouldAnimate) {
                                    playSound('pop');
                                }
                                
                                updateBoard(shouldAnimate);
                                updateGameStatus();
                                document.getElementById('benjaminScore').textContent = gameState.scores.benjamin;
                                document.getElementById('sanaaScore').textContent = gameState.scores.sanaa;
                                document.getElementById('drawScore').textContent = gameState.scores.draws;
                                
                                // Vérifier si le jeu vient de se terminer et afficher le modal
                                if (!gameState.gameActive && previousGameState.gameActive) {
                                    // Jouer le son de victoire/défaite quand l'adversaire termine la partie
                                    playSoundBasedOnResult();
                                    setTimeout(() => {
                                        showVictoryModal();
                                    }, 800); // Délai pour laisser l'animation du dernier pion se terminer
                                }
                            }
                        }
                    }
                )
                .subscribe();

            // Surveiller l'état de la connexion
            setTimeout(() => {
                if (subscription.state !== 'SUBSCRIBED') {
                    console.log('Reconnexion...');
                    setupRealTimeSubscription();
                }
            }, 10000);

            return subscription;
        }

        function getRandomMessage(type) {
            const messages = {
                benjamin: [
                    "Pouahhh trop fort !!",
                    "Hahaha bravo beau gosse",
                    "Easy peasy lemon squeezy",
                    "Compliqué de me battre, pas vrai ?",
                    "Héhéhé trop facile",
                    "Champion du monde !",
                    "Inarrêtable aujourd'hui",
                    "Technique parfaite !"
                ],
                sanaa: [
                    "Pfffff que de la chance...",
                    "Mouaisss pas mal du tout",
                    "En vrai je rigole, bien joué 😔",
                    "Tu commences à t'améliorer !",
                    "Impressionnant ma chérie 💕",
                    "Bravo ma princesse !",
                    "Tu es trop forte pour moi",
                    "Victoire bien méritée 👑",
                    "Ma reine des jeux !",
                    "Éblouissante performance ✨"
                ],
                draw: [
                    "On est trop forts, pas possible !",
                    "Connectés mentalement",
                    "Marions-nous maintenant",
                    "Parfaite harmonie !",
                    "Duo de légende",
                    "Même niveau, même amour"
                ]
            };
            return messages[type][Math.floor(Math.random() * messages[type].length)];
        }

        // Fonctions pour le modal de victoire
        function showVictoryModal() {
            const modal = document.getElementById('victoryModal');
            const icon = document.getElementById('victoryIcon');
            const title = document.getElementById('victoryTitle');
            const subtitle = document.getElementById('victorySubtitle');
            
            // Réinitialiser les classes
            modal.classList.remove('benjamin', 'sanaa', 'draw');
            
            // Mettre à jour les scores dans le modal
            document.getElementById('victoryBenjaminScore').textContent = gameState.scores.benjamin;
            document.getElementById('victorySanaaScore').textContent = gameState.scores.sanaa;
            document.getElementById('victoryDrawScore').textContent = gameState.scores.draws;
            
            // Configuration selon le résultat
            if (gameState.winner === 1) {
                modal.classList.add('benjamin');
                icon.textContent = '🔴';
                title.textContent = 'Benjamin a gagné !';
                subtitle.textContent = getRandomMessage('benjamin');
            } else if (gameState.winner === 2) {
                modal.classList.add('sanaa');
                icon.textContent = '🟡';
                title.textContent = 'Sanaa a gagné !';
                subtitle.textContent = getRandomMessage('sanaa');
            } else {
                modal.classList.add('draw');
                icon.textContent = '🤝';
                title.textContent = 'Égalité !';
                subtitle.textContent = getRandomMessage('draw');
            }
            
            // Afficher le modal avec animation
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
            }, 50);
        }

        function closeVictoryModal() {
            const modal = document.getElementById('victoryModal');
            
            modal.classList.add('closing');
            setTimeout(() => {
                modal.classList.remove('show', 'closing');
                modal.style.display = 'none';
            }, 300);
        }

        function startNewGameFromModal() {
            closeVictoryModal();
            setTimeout(() => {
                startNewGame();
            }, 400);
        }

        // Système de notifications
        function showNotification(message, type = 'info') {
            const oldNotif = document.querySelector('.notification');
            if (oldNotif) oldNotif.remove();

            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.innerHTML = `
                <span>${message}</span>
                <button class="close-notification" title="Fermer" aria-label="Fermer la notification">&times;</button>
            `;
            document.body.appendChild(notif);

            // Animation d'entrée
            setTimeout(() => {
                notif.classList.add('show');
            }, 10);

            // Fermeture manuelle
            notif.querySelector('.close-notification').onclick = () => {
                notif.classList.add('hide');
                setTimeout(() => notif.remove(), 600);
            };

            // Fermeture auto après 3s
            setTimeout(() => {
                if (document.body.contains(notif)) {
                    notif.classList.add('hide');
                    setTimeout(() => notif.remove(), 600);
                }
            }, 3000);
        }

        // Fonctions pour le modal de thème
        function openThemeModal() {
            const modal = document.getElementById('themeModal');
            const content = modal.querySelector('.theme-modal-content');
            
            modal.style.display = 'flex';
            modal.classList.remove('closing');
            content.classList.remove('animate-out');
            
            requestAnimationFrame(() => {
                modal.classList.add('show');
                content.classList.add('animate-in');
            });
        }

        function closeThemeModal() {
            const modal = document.getElementById('themeModal');
            const content = modal.querySelector('.theme-modal-content');
            
            modal.classList.add('closing');
            content.classList.remove('animate-in');
            content.classList.add('animate-out');
            
            setTimeout(() => {
                modal.classList.remove('show', 'closing');
                modal.style.display = 'none';
                content.classList.remove('animate-out');
            }, 300);
        }

        function changeTheme(themeName) {
            document.body.classList.remove(
                'theme-default', 'theme-yellow', 'theme-green', 'theme-pink', 
                'theme-red', 'theme-beige', 'theme-lavender', 'theme-peach', 'theme-mint'
            );

            document.body.classList.add(`theme-${themeName}`);

            document.querySelectorAll('.theme-circle').forEach(circle => {
                circle.classList.remove('active');
            });
            const targetCircle = document.getElementById(`theme-circle-${themeName}`);
            if (targetCircle) {
                targetCircle.classList.add('active');
            }

            localStorage.setItem('selectedTheme', themeName);
            localStorage.setItem('selectedTheme_timestamp', Date.now().toString());

            closeThemeModal();
        }

        // Fonctions pour le modal de paramètres
        function openSettingsModal() {
            const modal = document.getElementById('settingsModal');
            const content = modal.querySelector('.settings-modal-content');
            
            // Afficher l'utilisateur connecté
            const currentUser = sessionStorage.getItem('currentUser') || 'Benjamin';
            const userIndicator = document.getElementById('connectedUserIndicator');
            
            if (userIndicator) {
                // Choisir une icône appropriée selon l'utilisateur
                const userIcon = currentUser === 'Benjamin' ? 
                    '<i class="fas fa-user-circle" style="margin-right: 8px;"></i>' : 
                    '<i class="fas fa-heart" style="margin-right: 8px;"></i>';
                
                // Mise en forme améliorée avec icône
                userIndicator.innerHTML = `${userIcon}Connecté en tant que <strong>${currentUser}</strong>`;
            }
            
            // Mettre à jour les contrôles de volume
            updateVolumeControls();
            
            modal.style.display = 'flex';
            modal.classList.remove('closing');
            content.classList.remove('animate-out');
            
            requestAnimationFrame(() => {
                modal.classList.add('show');
                content.classList.add('animate-in');
            });
        }

        function closeSettingsModal() {
            const modal = document.getElementById('settingsModal');
            const content = modal.querySelector('.settings-modal-content');
            
            modal.classList.add('closing');
            content.classList.remove('animate-in');
            content.classList.add('animate-out');
            
            setTimeout(() => {
                modal.classList.remove('show', 'closing');
                modal.style.display = 'none';
                content.classList.remove('animate-out');
            }, 300);
        }

        function changeFont(fontName) {
            document.body.classList.remove(
                'font-default', 'font-serif', 'font-mono', 'font-cursive',
                'font-elegant', 'font-modern', 'font-handwriting', 'font-romantic',
                'font-minimal', 'font-retro'
            );
            
            document.body.classList.add(`font-${fontName}`);
            
            document.querySelectorAll('.font-option').forEach(option => {
                option.classList.remove('active');
            });
            
            const fontOption = document.getElementById(`font-option-${fontName}`);
            if (fontOption) {
                fontOption.classList.add('active');
            }
            
            localStorage.setItem('selectedFont', fontName);
            localStorage.setItem('selectedFont_timestamp', Date.now().toString());
        }

        // Fermer les modaux lorsqu'on clique en dehors (compatible iOS)
        function setupModalClickOutside() {
            const modals = [
                { element: document.getElementById('themeModal'), closeFunction: closeThemeModal },
                { element: document.getElementById('settingsModal'), closeFunction: closeSettingsModal },
                { element: document.getElementById('victoryModal'), closeFunction: closeVictoryModal },
                { element: document.getElementById('confirmationModal'), closeFunction: closeConfirmationModal }
            ];

            modals.forEach(modal => {
                if (modal.element) {
                    // Variable pour éviter les doubles événements
                    let touchStarted = false;
                    
                    // Événement click (desktop et certains mobiles)
                    modal.element.addEventListener('click', function(event) {
                        if (event.target === modal.element && !touchStarted) {
                            modal.closeFunction();
                        }
                    });
                    
                    // Événement touchstart pour iOS (iPhone/iPad)
                    modal.element.addEventListener('touchstart', function(event) {
                        if (event.target === modal.element) {
                            touchStarted = true;
                        }
                    }, { passive: true });
                    
                    // Événement touchend pour iOS (iPhone/iPad) - plus fiable
                    modal.element.addEventListener('touchend', function(event) {
                        if (event.target === modal.element && touchStarted) {
                            event.preventDefault();
                            modal.closeFunction();
                        }
                        touchStarted = false;
                    }, { passive: false });
                    
                    // Reset au cas où touch est annulé
                    modal.element.addEventListener('touchcancel', function() {
                        touchStarted = false;
                    });
                    
                    // Ajout de cursor pointer pour indiquer que c'est cliquable
                    modal.element.style.cursor = 'pointer';
                }
            });
        }

        // Fonctions d'authentification
        function isAuthenticated() {
            const isAuth = sessionStorage.getItem('isAuthenticated');
            const authTime = sessionStorage.getItem('authTime');
            
            if (!isAuth || !authTime) {
                return false;
            }
            
            const now = Date.now();
            const authTimestamp = parseInt(authTime);
            const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 heures
            
            // Vérifier si la session n'a pas expiré
            if (now - authTimestamp > SESSION_DURATION) {
                // Session expirée, nettoyer
                sessionStorage.removeItem('isAuthenticated');
                sessionStorage.removeItem('authTime');
                sessionStorage.removeItem('currentUser');
                return false;
            }
            
            return isAuth === 'true';
        }

        function redirectToLogin() {
            // Sauvegarder l'URL actuelle pour redirection après connexion
            sessionStorage.setItem('redirectAfterLogin', window.location.href);
            
            // Rediriger vers la page d'authentification
            window.location.href = 'index.html';
        }

        // Gestion des touches clavier pour fermer les modaux
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeThemeModal();
                closeSettingsModal();
                closeVictoryModal();
                closeConfirmationModal();
            }
        });
    </script>
</body>
</html>
